---
import Layout from '../../layouts/Layout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { sanityClient } from 'sanity:client';
import { urlFor } from '../../lib/urlFor';

export async function getStaticPaths() {
  const products = await sanityClient.fetch(`*[_type in ["producto", "product"] && defined(slug.current)] { slug }`);
  return products.map((product: any) => ({ params: { slug: product.slug.current } }));
}

const { slug } = Astro.params;

const product = await sanityClient.fetch(`*[_type in ["producto", "product"] && slug.current == $slug][0] {
  nombre, title, 
  "textoDescripcion": pt::text(description),
  "textoDescripcionES": pt::text(descripcion),
  precio, price, 
  images[] { ..., asset-> },
  imagen, image, mainImage
}`, { slug });

if (!product) { return Astro.redirect('/404'); }

const nombre = product.nombre || product.title;
let rawPrice = product.precio || product.price || "Consultar";
if (typeof rawPrice === 'string') rawPrice = rawPrice.replace('€', '').replace('EUR', '').trim();

const fullDescription = product.textoDescripcion || product.textoDescripcionES || `Pastel de pañales ${nombre} hecho a mano.`;
const metaDescription = fullDescription.slice(0, 155) + "...";

// Lógica de Imagen
let imagenData = null;
let altText = `Comprar ${nombre} - Regalo bebé Badalona`;
if (product.images && product.images.length > 0) {
  imagenData = product.images[0];
  if (imagenData.alt) altText = imagenData.alt;
} else {
  imagenData = product.imagen || product.image || product.mainImage;
}
const imagenUrl = imagenData ? urlFor(imagenData).width(800).format('webp').url() : "";

// Schema SEO mejorado
const siteUrl = "https://www.xn--manolipastelesdepaales-1ec.com";
const productSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Product",
  "@id": `${siteUrl}/productos/${slug}#product`,
  "name": nombre,
  "image": imagenUrl,
  "description": fullDescription,
  "sku": slug,
  "mpn": slug,
  "brand": {
    "@type": "Brand",
    "name": "Manoli Pasteles de Pañales"
  },
  "manufacturer": {
    "@type": "LocalBusiness",
    "name": "Manoli Pasteles de Pañales",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Badalona",
      "addressRegion": "Barcelona",
      "addressCountry": "ES"
    }
  },
  "category": "Regalos para Bebés",
  "audience": {
    "@type": "PeopleAudience",
    "suggestedGender": "unisex",
    "suggestedMinAge": "0 months"
  },
  "offers": {
    "@type": "Offer",
    "url": `${siteUrl}/productos/${slug}`,
    "priceCurrency": "EUR",
    "price": rawPrice,
    "priceValidUntil": new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
    "availability": "https://schema.org/InStock",
    "itemCondition": "https://schema.org/NewCondition",
    "seller": {
      "@type": "LocalBusiness",
      "name": "Manoli Pasteles de Pañales",
      "@id": `${siteUrl}/#business`
    },
    "shippingDetails": {
      "@type": "OfferShippingDetails",
      "shippingDestination": [
        {
          "@type": "DefinedRegion",
          "addressCountry": "ES",
          "addressRegion": ["Barcelona"]
        }
      ],
      "deliveryTime": {
        "@type": "ShippingDeliveryTime",
        "handlingTime": {
          "@type": "QuantitativeValue",
          "minValue": 1,
          "maxValue": 3,
          "unitCode": "DAY"
        }
      }
    },
    "areaServed": [
      { "@type": "City", "name": "Badalona" },
      { "@type": "City", "name": "Barcelona" }
    ]
  }
});
---

<Layout title={`${nombre} | Manoli Pasteles`} description={metaDescription} image={imagenUrl}>
  <script type="application/ld+json" set:html={productSchema} />

  <Breadcrumbs items={[
    { name: "Catálogo", url: "/productos" },
    { name: nombre }
  ]} />

  <div class="bg-pink-50 py-12 md:py-20 min-h-screen">
    <div class="container mx-auto px-4">

      <div class="bg-white rounded-3xl shadow-xl overflow-hidden max-w-5xl mx-auto flex flex-col md:flex-row">
        <div class="md:w-1/2 bg-white p-8 flex items-center justify-center border-r border-gray-100">
          {imagenUrl ? (
            <img 
              src={urlFor(imagenData).width(800).format('webp').url()} 
              alt={altText} 
              class="w-full h-auto object-contain hover:scale-105 transition duration-500" 
              loading="eager"
              fetchpriority="high"
            />
          ) : (
            <div class="text-gray-300 font-bold border-2 border-dashed p-10">Sin Imagen</div>
          )}
        </div>

        <div class="md:w-1/2 p-8 md:p-12 flex flex-col justify-center">
          <span class="text-pink-500 font-bold text-xs uppercase mb-2 bg-pink-100 w-fit px-2 py-1 rounded">Badalona</span>
          <h1 class="text-3xl md:text-4xl font-serif font-bold text-gray-900 mb-4">{nombre}</h1>
          <div class="text-3xl font-bold text-pink-600 mb-6">{rawPrice}€</div>
          <p class="text-gray-600 mb-8 whitespace-pre-line">{fullDescription}</p>
          
          <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100">
            <h3 class="font-bold text-gray-900 mb-4">¿Te interesa?</h3>
            <a href={`/contacto?asunto=Interesado en ${nombre}`} class="block w-full text-center bg-pink-600 text-white font-bold py-4 rounded-xl hover:bg-pink-700 transition shadow-lg">
              Pedir por WhatsApp / Email
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>